CSP est un mécanisme de sécurité pour navigateur visant à atténuer les attaques XSS et autres. Il fonctionne en limitant les ressources (telles que les scripts et les images) qu'une page peut charger et en limitant la possibilité pour une page d'être encadrée par d'autres pages.

Pour activer CSP, une réponse doit inclure un en-tête de réponse HTTP appelé `Content-Security-Policy`avec une valeur contenant la politique. La politique elle-même est composée d'une ou plusieurs directives, séparées par des points-virgules.

## Bypassing CSP with policy injection

Si un site reflète un paramètre dans la directive `report-uri` de sa politique CSP, un attaquant peut manipuler ce paramètre pour **injecter** ses propres directives CSP.

```js
// example
Content-Security-Policy: default-src 'self'; object-src 'none';script-src 'self'; style-src 'self'; report-uri /csp-report?token=
```

**Méthode :**

1. L'attaquant contrôle un paramètre (ex : `?token=...`).
2. Il injecte un point-virgule (`;`) pour ajouter ses propres directives après celles déjà existantes.
3. Le `report-uri` est souvent la dernière directive, donc l'attaquant peut écraser les directives existantes

**Exploitation de la vulnérabilité :**

- Normalement, on ne peut pas écraser `script-src`, mais **Chrome a introduit `script-src-elem`**, qui permet de contrôler les **éléments `<script>`** (et non les événements).
    
- Cela permet à un attaquant de **contourner** la politique CSP, en injectant des scripts malveillants via des éléments `<script>`.

**Exploitation**

```js
script-src-elem *
script-src-elem 'unsafe-eval'
script-src-elem 'unsafe-inline'
```

```http
https://target.com/?search=<script>alert(1)</script>&token=;script-src-elem 'unsafe-inline'
```

> En gros, l'attaque consiste à manipuler `report-uri` pour **ajouter des directives CSP malveillantes** (comme autoriser des sources de scripts non sécurisées).


