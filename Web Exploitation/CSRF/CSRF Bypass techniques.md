# Bypassing CSRF token validation

Un jeton CSRF est une valeur unique, secrète et imprévisible, générée par l'application côté serveur et partagée avec le client. Lorsqu'il émet une requête pour effectuer une action sensible, comme l'envoi d'un formulaire, le client doit inclure le jeton CSRF correct. Dans le cas contraire, le serveur refusera l'action demandée.

> Correctement implémentés, les jetons CSRF protègent contre les attaques CSRF en empêchant un attaquant de créer une requête valide pour le compte de la victime. Comme l'attaquant n'a aucun moyen de prédire la valeur correcte du jeton CSRF, il ne pourra pas l'inclure dans la requête malveillante.

### Défauts courants dans la validation des jetons CSRF

Les vulnérabilités CSRF surviennent généralement en raison d'une validation défectueuse des jetons CSRF

##### 1. Validation of CSRF token depends on request method

(La validation du jeton CSRF dépend de la méthode de demande)

Certaines applications valident correctement le jeton lorsque la requête utilise la méthode POST, mais ignorent la validation lorsque la méthode GET est utilisée.

> Dans cette situation, l'attaquant peut passer à la méthode GET pour contourner la validation et lancer une attaque CSRF

> Si l’app vérifie le token **seulement** pour POST, un attaquant peut forcer une requête **GET** pour exécuter une action sans token.

```http
GET /email/change?email=pwned@evil-user.net 
HTTP/1.1 Host: vulnerable-website.com 
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
```


**2. Validation of CSRF token depends on token being present**

(La validation du jeton CSRF dépend de la présence du jeton)

Certaines applications valident correctement le jeton lorsqu'il est présent, mais ignorent la validation si le jeton est omis.

> Dans cette situation, l'attaquant peut supprimer l'intégralité du paramètre contenant le jeton (pas seulement sa valeur) pour contourner la validation et lancer une attaque CSRF

> Si l’app **n’ouvre** la vérification que quand le paramètre token existe, un attaquant peut appeler l’endpoint **sans** ce paramètre (le supprimer) et contourner la protection.

```http
POST /email/change HTTP/1.1 Host: vulnerable-website.com 
Content-Type: application/x-www-form-urlencoded 
Content-Length: 25 
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm 

email=pwned@evil-user.net
```


**3. CSRF token is not tied to the user session**

(Le jeton CSRF n'est pas lié à la session utilisateur)

Certaines applications ne vérifient pas que le jeton appartient à la même session que l'utilisateur à l'origine de la requête. Elles gèrent alors un pool global de jetons qu'elles ont émis et acceptent tout jeton qui y figure.

> Dans cette situation, l'attaquant peut se connecter à l'application en utilisant son propre compte, obtenir un jeton valide, puis transmettre ce jeton à l'utilisateur victime dans son attaque CSRF

> Si le token n’est **pas lié** à la session, un attaquant peut s’authentifier, récupérer un token valide et l’utiliser contre une victime.

> Cela peut arrive que le token n'es utiliser que une seule fois


**4. CSRF token is tied to a non-session cookie**

(Le jeton CSRF est lié à un cookie non-session)

Dans une variante de la vulnérabilité précédente, certaines applications associent le jeton CSRF à un cookie, mais pas à celui utilisé pour le suivi des sessions. Ce problème peut facilement se produire lorsqu'une application utilise deux infrastructures distinctes, l'une pour la gestion des sessions et l'autre pour la protection CSRF, qui ne sont pas intégrées

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&email=wiener@normal-user.com
```

Cette situation est plus difficile à exploiter, mais reste vulnérable. **Si le site web présente un comportement permettant à un attaquant d'installer un cookie dans le navigateur de la victime, une attaque est possible.**

> L'attaquant peut se connecter à l'application avec son propre compte, obtenir un jeton valide et le cookie associé, exploiter le comportement d'installation de cookie pour installer son cookie dans le navigateur de la victime et lui transmettre son jeton lors de son attaque CSRF.

# Bypassing SameSite cookie restrictions
### test

**sds**

()

# Bypassing Referer-based CSRF defenses
