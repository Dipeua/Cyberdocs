# Cross-site request forgery (CSRF)

est une vulnérabilité de sécurité web qui permet à un attaquant d'inciter les utilisateurs à effectuer des actions non intentionnelles. Elle permet également de contourner partiellement la politique de même origine, conçue pour empêcher les interférences entre différents sites web.

### Impact d’une attaque CSRF 

Une attaque CSRF réussie, permet a l'attaquant d'incite l'utilisateur victime à effectuer une action involontaire. Par exemple, il peut s'agir de modifier l'adresse e-mail de son compte, de changer son mot de passe ou d'effectuer un virement.

> Les attaques CSRF ciblent les fonctionnalités qui provoquent un changement d'état sur le serveur, comme la modification de l'adresse e-mail ou du mot de passe de la victime, ou acheter quelque chose
#### Comment fonctionne le CSRF ?

Pour qu'une attaque CSRF soit possible, trois conditions clés doivent être réunies :

- **Une action pertinente.** Il existe une action dans l'application que l'attaquant a une raison d'induire. Il peut s'agir d'une action privilégiée (comme la modification des autorisations d'autres utilisateurs) ou de toute action sur des données spécifiques à l'utilisateur (comme la modification de son propre mot de passe).

- **Gestion des sessions basée sur les cookies.** L'exécution de l'action implique l'émission d'une ou plusieurs requêtes HTTP, et l'application s'appuie uniquement sur les cookies de session pour identifier l'utilisateur à l'origine des requêtes. Aucun autre mécanisme n'est en place pour suivre les sessions ou valider les requêtes des utilisateurs.

- **Aucun paramètre de requête imprévisible.** Les requêtes exécutant l'action ne contiennent aucun paramètre dont l'attaquant ne puisse déterminer ou deviner la valeur. Par exemple, lorsqu'un utilisateur doit modifier son mot de passe, la fonction n'est pas vulnérable si un attaquant a besoin de connaître la valeur du mot de passe existant.

##### Exemples

Supposons qu'une application contienne une fonction permettant à l'utilisateur de modifier l'adresse e-mail de son compte. Lorsqu'il effectue cette action, il envoie une requête HTTP comme celle-ci :

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=wiener@normal-user.com
```

Cela répond aux conditions requises pour le CSRF :

- La modification de l'adresse e-mail d'un compte utilisateur est susceptible d'intéresser un attaquant. Cette action lui permet généralement de réinitialiser le mot de passe et de prendre le contrôle total du compte.
- L'application utilise un cookie de session pour identifier l'utilisateur à l'origine de la requête. Aucun autre jeton ni mécanisme n'est utilisé pour suivre les sessions utilisateur.
- L’attaquant peut facilement déterminer les valeurs des paramètres de requête nécessaires pour effectuer l’action.

Avec ces conditions en place, l’attaquant peut construire une page Web contenant le code HTML suivant :

```html
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="POST">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
```

Si un utilisateur victime visite la page Web de l’attaquant, ce qui suit se produira :

- La page de l’attaquant déclenchera une requête HTTP vers le site Web vulnérable.
- Si l'utilisateur est connecté au site Web vulnérable, son navigateur inclura automatiquement son cookie de session dans la demande (en supposant que [les cookies SameSite](https://portswigger.net/web-security/csrf#common-defences-against-csrf) ne sont pas utilisés).
- Le site Web vulnérable traitera la demande de manière normale, la considérera comme ayant été faite par l'utilisateur victime et modifiera son adresse e-mail.


---

Action **non vulnérable** (paramètre imprévisible) — attaque bloquée :

```http
POST /account/change-email
Cookie: session=ABC123

body: email=victim2@example.com
      current_password=monMotDePasseActuel
```

Ici la requête exige le **mot de passe actuel** : l’attaquant ne le connaît pas, donc ne peut pas forger la requête valide. Même si la victime est connectée, la requête malicieuse échouera (authentification/validation côté serveur).