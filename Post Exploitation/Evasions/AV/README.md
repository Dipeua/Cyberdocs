Nous avons deux types d'évasion AV :
- On-Disk evasion (Évasion sur disque)
- In-Memory evasion(Évasion en mémoire)

**AMSI (Anti Malware Scan Interface)**
AMSI est essentiellement une fonctionnalité de Windows qui analyse les scripts lorsqu'ils entrent dans la mémoire. 
Il ne vérifie pas réellement les scripts eux-mêmes, mais il fournit des crochets que les éditeurs AV peuvent utiliser - permettant essentiellement aux logiciels antivirus existants d'obtenir une copie du script en cours d'exécution, de l'analyser et de décider s'il est sûr ou non de l'exécuter.

En termes de méthodologie : idéalement, nous commencerions par essayer de prendre les empreintes digitales de l'AV sur la cible pour avoir une idée de la solution à laquelle nous sommes confrontés

Si nous avons déjà un shell sur la cible, nous pouvons également utiliser des programmes tels que `SharpEDRChecker` et `Seatbelt` pour identifier la solution antivirus installée.

_Une fois que nous connaissons la version du système d'exploitation et l'AV de la cible, nous tentons alors de répliquer cet environnement dans une machine virtuelle que nous pouvons utiliser pour tester les charges utiles._

_Notez qu'il faut _toujours_désactivez tout type de protection basée sur le cloud dans les paramètres AV (potentiellement en déconnectant carrément la VM d'Internet) afin que l'AV ne télécharge pas nos charges utiles soigneusement conçues sur un serveur quelque part pour analyse, détruisant tout notre travail acharné. Une fois que nous avons une charge utile fonctionnelle, nous pouvons alors la déployer contre la cible !_


AV Evasion implique généralement une certaine forme d'obscurcissement en ce qui concerne les charges utiles.
Le but est de changer suffisamment les choses pour que le logiciel AV soit incapable de détecter quoi que ce soit de mauvais.

## Méthodes de détection AV
Les logiciels antivirus modernes s'appuient généralement sur une combinaison de ceux-ci.
- **Static Detection (Détection statique)**
Les méthodes de détection statique impliquent généralement une sorte de détection de signature.
>> Un système très rudimentaire, par exemple, prendrait le hashsum du fichier suspect et le comparerait à une base de données de hashsums de logiciels malveillants connus. Ce système a tendance à être utilisé; cependant, il ne serait jamais utilisé seul dans les solutions antivirus modernes. Pour cette raison, c'est généralement une bonne idée de changer quelque chose lorsque vous travaillez avec un exploit connu. La plus petite modification apportée au fichier entraînera une somme de hachage complètement différente, donc même quelque chose d'aussi petit que la modification d'une chaîne dans le message d'aide suffirait à contourner ce type de système de détection rudimentaire.

>> L'autre forme de détection statique qui est souvent utilisée dans les logiciels antivirus est une technique appelée `correspondance d'octets`

- Dynamic / Heuristic / Behavioural Detection (Détection dynamique / heuristique / comportementale)

Alors que les méthodes statiques de détection des virus malveillants examinent le fichier lui-même, les méthodes dynamiques examinent la façon dont le fichier agit:

- Le logiciel AV peut parcourir l'exécutable ligne par ligne en vérifiant le flux d'exécution. 
(par exemple, le programme accède-t-il à un mauvais site Web connu, ou manipule-t-il des valeurs dans le registre qu'il ne devrait pas être ?), l'AV peut voir comment le programme a l' intention agir et prendre des décisions en conséquence

- Le logiciel suspect peut être exécuté directement dans un environnement sandbox sous la surveillance étroite du logiciel AV. Si le programme agit de manière malveillante, il est mis en quarantaine et signalé comme logiciel malveillant

> Tout ce qui est différent est bon lorsqu'il s'agit d'évasion AV